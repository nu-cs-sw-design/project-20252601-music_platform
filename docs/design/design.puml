@startuml
title UC2 + UC5 + UC6: Edit Notes, Play/Pause, Change Tempo, Save Loop

package View {
    class Main {
        +{static} main(args: String[]): void
    }

    class MainView {
        -pianoRollView: PianoRollView
        -currentLoop: Loop

        +MainView()
        +showMainScreen(loop: Loop): void
        +showAudioError(): void

        +setPianoRollListener(listener: PianoRollListener): void
        +setTransportListener(listener: TransportListener): void
        +setTempoListener(listener: TempoListener): void
        +setSaveLoopListener(listener: SaveLoopListener): void

        +refreshPianoRoll(): void
        +setStatusMessage(message: String): void
        +setTempoDisplay(bpm: double): void
    }

    class PianoRollView {
        -loop: Loop
        -listener: PianoRollListener

        +PianoRollView()
        +setMeasures(measures: int): void
        +setLoop(loop: Loop): void
        +setPianoRollListener(listener: PianoRollListener): void
    }

    interface PianoRollListener {
        +onEmptyCellClicked(beat: double, pitchIndex: int): void
        +onNoteClicked(note: LoopNote): void
    }

    interface TransportListener {
        +onPlayRequested(): void
        +onPauseRequested(): void
    }

    interface TempoListener {
        +onTempoChangeRequested(bpmText: String): void
    }

    interface SaveLoopListener {
        +onSaveLoopRequested(): void
    }
}

package Model {
    class Loop {
        -notes: List<LoopNote>
        -measures: int
        -tempoBPM: double

        +Loop(measures: int)
        +addNote(note: LoopNote): void
        +removeNote(note: LoopNote): void
        +getNotes(): List<LoopNote>
        +getMeasures(): int
        +getTempoBPM(): double
        +setTempoBPM(tempoBPM: double): void
    }

    class LoopNote {
        -pitch: int
        -startBeat: double
        -durationBeats: double
        -velocity: int

        +LoopNote(pitch: int, startBeat: double, durationBeats: double, velocity: int)
        +getPitch(): int
        +getStartBeat(): double
        +getDurationBeats(): double
        +getVelocity(): int
    }
}

package Controller {
    class AppController {
        -audioEngine: AudioEngine
        -loopSequencer: LoopSequencer
        -loopStorage: LoopJsonStorage
        -mainView: MainView
        -currentLoop: Loop

        +AppController(mainView: MainView, audioEngine: AudioEngine, loop: Loop)
        +startApplication(): void

        +onEmptyCellClicked(beat: double, pitchIndex: int): void
        +onNoteClicked(note: LoopNote): void
        +onPlayRequested(): void
        +onPauseRequested(): void
        +onTempoChangeRequested(bpmText: String): void
        +onSaveLoopRequested(): void
    }

    AppController --|> PianoRollListener
    AppController --|> TransportListener
    AppController --|> TempoListener
    AppController --|> SaveLoopListener

    package engine {
        interface Instrument {
            +noteOn(pitch: int, vel: int): void
            +noteOff(pitch: int): void
            +close(): void
        }

        class PianoInstrument implements Instrument {
            +PianoInstrument()
            +noteOn(pitch: int, vel: int): void
            +noteOff(pitch: int): void
            +close(): void
        }

        class AudioEngine {
            -instrument: Instrument
            +AudioEngine()
            +initialize(): boolean
            +noteOn(pitch: int, vel: int): void
            +noteOff(pitch: int): void
        }

        class LoopSequencer {
            -audioEngine: AudioEngine
            -beatsPerMeasure: int

            +LoopSequencer(audioEngine: AudioEngine, beatsPerMeasure: int)
            +play(loop: Loop): void
            +pause(): void
            +isPlaying(): boolean
        }
    }
}

package persistence {
    class LoopJsonStorage {
        -baseDirectory: Path

        +LoopJsonStorage(baseDirectory: Path)
        +saveLoop(loop: Loop, fileName: String): void
    }
}

' --- Relationships ---

Main ..> AppController : "creates and calls"
Main ..> MainView
Main ..> AudioEngine
Main ..> Loop : "creates 4-measure loop"

MainView --> PianoRollView : "contains"
MainView --> Loop : "displays"
MainView --> PianoRollListener : "wires piano roll"
MainView --> TransportListener : "wires transport"
MainView --> TempoListener : "wires tempo"
MainView --> SaveLoopListener : "wires save loop"

PianoRollView --> Loop : "renders"
PianoRollView ..> LoopNote : "hit-detects notes"
PianoRollView --> PianoRollListener : "notifies on click"

AppController --> MainView
AppController --> AudioEngine
AppController --> LoopSequencer
AppController --> LoopJsonStorage
AppController --> Loop : "currentLoop"

Controller.engine.PianoInstrument --|> Controller.engine.Instrument
Controller.engine.AudioEngine --> Controller.engine.Instrument : "default piano"

Loop --> LoopNote : "contains notes"

Controller.engine.LoopSequencer --> Controller.engine.AudioEngine
Controller.engine.LoopSequencer --> Loop

persistence.LoopJsonStorage --> Loop
persistence.LoopJsonStorage ..> LoopNote

@enduml
