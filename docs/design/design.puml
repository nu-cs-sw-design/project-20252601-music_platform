@startuml
title LoopSketch Design

package view {
    class Main {
        +{static} main(args: String[]): void
    }

    class MainView {
        -statusLabel: JLabel
        -pianoRollView: PianoRollView
        -currentLoop: Loop

        -transportListener: TransportListener
        -pianoRollListener: PianoRollListener
        -tempoListener: TempoListener
        -saveLoopListener: SaveLoopListener

        -tempoField: JTextField

        +MainView()
        +showMainScreen(loop: Loop): void
        +showAudioError(): void

        +setPianoRollListener(listener: PianoRollListener): void
        +setTransportListener(transportListener: TransportListener): void
        +setTempoListener(tempoListener: TempoListener): void
        +setSaveLoopListener(saveLoopListener: SaveLoopListener): void

        +refreshPianoRoll(): void
        +setStatusMessage(message: String): void
        +setTempoDisplay(bpm: double): void
    }


    class PianoRollView {
        -beatsPerMeasure: int
        -stepsPerBeat: int
        -numPitches: int

        -loop: Loop
        -listener: PianoRollListener

        -{static} PADDING_LEFT: int
        -{static} PADDING_RIGHT: int
        -{static} PADDING_TOP: int
        -{static} PADDING_BOTTOM: int

        +PianoRollView()
        +setLoop(loop: Loop): void
        +setPianoRollListener(listener: PianoRollListener): void

        #paintComponent(g: Graphics): void

        -drawGrid(g2: Graphics2D, gridX: int, gridY: int, gridWidth: int, gridHeight: int, measures: int): void
        -drawNotes(g2: Graphics2D, gridX: int, gridY: int, gridWidth: int, gridHeight: int, measures: int): void
        -computeNoteRect(note: LoopNote, gridX: int, gridY: int, gridWidth: int, gridHeight: int, totalBeats: int, beatWidth: double, rowHeight: double): Rectangle
        -handleClick(mouseX: int, mouseY: int): void
    }

    interface PianoRollListener {
        +onEmptyCellClicked(beat: double, pitchIndex: int): void
        +onNoteClicked(note: LoopNote): void
    }

    interface TransportListener {
        +onPlayRequested(): void
        +onPauseRequested(): void
    }

    interface TempoListener {
        +onTempoChangeRequested(bpmText: String): void
    }

    interface SaveLoopListener {
        +onSaveLoopRequested(): void
    }
}

package model {
    class Loop {
        -notes: List<LoopNote>
        -measures: Measures
        -tempo: Tempo

        +Loop(measures: Measures)

        +addNote(note: LoopNote): void
        +removeNote(note: LoopNote): void
        +getNotes(): List<LoopNote>

        +getMeasures(): Measures
        +getMeasureCount(): int
        +setMeasures(measures: Measures): void
        +addMeasures(delta: int): void
        +subtractMeasures(delta: int): void

        +getTempo(): Tempo
        +getTempoBPM(): double
        +setTempo(tempo: Tempo): void
        +setTempoBPM(bpm: double): void
        +increaseTempo(deltaBpm: double): void
        +decreaseTempo(deltaBpm: double): void
    }


    class LoopNote {
        -pitch: Pitch
        -startBeat: BeatPosition
        -durationBeats: BeatDuration
        -velocity: Velocity

        +LoopNote(pitch: Pitch, startBeat: BeatPosition, durationBeats: BeatDuration, velocity: Velocity)
        +getPitch(): Pitch
        +getStartBeat(): BeatPosition
        +getDurationBeats(): BeatDuration
        +getVelocity(): Velocity
    }

    class Pitch {
        -midiNumber: int
        +Pitch(midiNumber: int)
        +getMidiNumber(): int
        +transpose(semitones: int): Pitch
        +toString(): String
    }

    class Velocity {
        -value: int
        +Velocity(value: int)
        +getValue(): int
        +scaled(factor: double): Velocity
        +toString(): String
    }

    class BeatPosition {
        -value: double
        +BeatPosition(value: double)
        +getValue(): double
        +toString(): String
    }

    class BeatDuration {
        -value: double
        +BeatDuration(value: double)
        +getValue(): double
        +toString(): String
    }

    class Tempo {
        -bpm: double
        +Tempo(bpm: double)
        +getBpm(): double
        +add(deltaBpm: double): Tempo
        +subtract(deltaBpm: double): Tempo
        +toString(): String
    }

    class Measures {
        -value: int
        +Measures(value: int)
        +getValue(): int
        +add(delta: int): Measures
        +subtract(delta: int): Measures
        +toString(): String
    }

    package persistence {
        interface LoopStorage {
            +saveLoop(loop: Loop, fileName: String): void
        }

        class LoopJsonStorage implements LoopStorage {
            -baseDirectory: Path

            +LoopJsonStorage(baseDirectory: Path)
            -ensureDirectoryExists(): void
            +saveLoop(loop: Loop, fileName: String): void
            -buildJson(loop: Loop): String
        }
    }
}

package controller {
    class AppController {
        -audioEngine: AudioEngine
        -loopSequencer: LoopSequencer
        -mainView: MainView
        -currentLoop: Loop
        -loopStorage: LoopStorage

        +AppController(mainView: MainView,
                       audioEngine: AudioEngine,
                       loop: Loop,
                       loopStorage: LoopStorage)

        +startApplication(): void

        +onEmptyCellClicked(beat: double, pitchIndex: int): void
        +onNoteClicked(note: LoopNote): void

        +onPlayRequested(): void
        +onPauseRequested(): void

        +onTempoChangeRequested(bpmText: String): void
        +onSaveLoopRequested(): void
    }
    AppController --|> PianoRollListener
    AppController --|> TransportListener
    AppController --|> TempoListener
    AppController --|> SaveLoopListener

    package engine {
        interface Instrument {
            +noteOn(pitch: Pitch, velocity: Velocity): void
            +noteOff(pitch: Pitch): void
            +close(): void
        }


        class PianoInstrument implements Instrument {
            -synth: Synthesizer
            -channel: MidiChannel
            -{static} BASE_MIDI_NOTE: int

            +PianoInstrument()
            +noteOn(pitch: Pitch, velocity: Velocity): void
            +noteOff(pitch: Pitch): void
            +close(): void
        }



        class AudioEngine {
            -instrument: Instrument

            +AudioEngine()
            +initialize(): boolean
            +noteOn(pitch: Pitch, velocity: Velocity): void
            +noteOff(pitch: Pitch): void
        }


        class LoopSequencer {
            -audioEngine: AudioEngine
            -beatsPerMeasure: int

            -playing: boolean
            -playbackThread: Thread

            +LoopSequencer(audioEngine: AudioEngine, beatsPerMeasure: int)
            +play(loop: Loop): void
            +pause(): void
            +isPlaying(): boolean

            -runPlaybackLoop(loop: Loop): void
            -sleepUntil(targetTimeNs: long): void
            -stopAllNotes(): void
        }

        -class NoteEvent {
            ~beat: double
            ~isNoteOn: boolean
            ~note: LoopNote
        }


        NoteEvent --|> LoopSequencer : "Internal private class"

    }
}

' --- Relationships ---

view.Main ..> controller.AppController : "creates and calls"
view.Main ..> view.MainView
view.Main ..> controller.engine.AudioEngine
view.Main ..> model.Loop : "creates 4-measure loop"
view.Main ..> model.persistence.LoopJsonStorage : "creates concrete storage"
view.Main ..> model.persistence.LoopStorage : "passes as interface"

view.MainView --> view.PianoRollView : "contains"
view.MainView --> model.Loop : "displays"
view.MainView --> view.PianoRollListener : "wires piano roll"
view.MainView --> view.TransportListener : "wires transport"
view.MainView --> view.TempoListener : "wires tempo"
view.MainView --> view.SaveLoopListener : "wires save loop"

view.PianoRollView --> model.Loop : "renders"
view.PianoRollView ..> model.LoopNote : "hit-detects notes"
view.PianoRollView --> view.PianoRollListener : "notifies on click"

controller.AppController --> view.MainView
controller.AppController --> controller.engine.AudioEngine
controller.AppController --> controller.engine.LoopSequencer
controller.AppController --> model.persistence.LoopStorage
controller.AppController --> model.Loop : "currentLoop"

controller.engine.AudioEngine --> controller.engine.Instrument : "default piano"

model.Loop --> model.LoopNote : "contains notes"

model.LoopNote --> model.Pitch
model.LoopNote --> model.BeatPosition
model.LoopNote --> model.BeatDuration
model.LoopNote --> model.Velocity

model.Loop --> model.Measures
model.Loop --> model.Tempo

controller.engine.LoopSequencer --> controller.engine.AudioEngine
controller.engine.LoopSequencer --> model.Loop

model.persistence.LoopStorage --> model.Loop
model.persistence.LoopStorage ..> model.LoopNote

model.persistence.LoopJsonStorage --> model.Loop
model.persistence.LoopJsonStorage ..> model.LoopNote

@enduml
